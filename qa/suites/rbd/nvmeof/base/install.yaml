use_shaman: True
tasks:
- cephadm:
- cephadm.shell:
    host.a:
    # get state before nvmeof deployment
    - ceph orch status
    - ceph orch ps
    - ceph orch ls
    - ceph orch host ls
    - ceph orch device ls
    - ceph osd lspools
    # create pool
    - ceph osd pool create mypool
    - ceph osd pool application enable mypool rbd
    - ceph osd lspools
    - ceph osd pool ls detail
    # deploy nvmeof
    - ceph config set mgr mgr/cephadm/container_image_nvmeof quay.io/ceph/nvmeof:0.0.3
    - ceph config get mgr mgr/cephadm/container_image_nvmeof
    - ceph orch apply nvmeof mypool --placement="1 $(hostname)"
    - ceph orch ps --refresh
    - ceph versions
    - ceph -s
    - ceph orch ls
    - rbd create mypool/myimage --size 8Gi
    - rbd ls mypool

- cephadm.wait_for_service:
    service: nvmeof.mypool

- exec:
    host.a:
    - |
      set -ex
      # print nvmeof start up logs
      SERVICE=$(systemctl list-units | grep nvmeof.mypool | awk '{print $1}')
      cat journalctl -u $SERVICE
      GATEWAY=$(echo $SERVICE | cut -d "@" -f2 | awk 'BEGIN{FS=OFS="."} NF--')

#- install:
#    extra_packages:
#    - nvme-cli

- exec:
    client.0:
    - "modprobe nvme-fabrics"
    - |
      set -ex
      #
      HOSTNAME=$(hostname)
      IP=$(hostname -I)
      IMAGE="quay.io/ceph/nvmeof-cli:0.0.3"
      POOL="mypool"
      MIMAGE="myimage"
      BDEV="mybdev"
      SERIAL="SPDK00000000000001"
      NQN="nqn.2016-06.io.spdk:cnode1"
      PORT="4420"
      SRPORT="5500"
      podman run -it $IMAGE --server-address $IP --server-port $SRPORT create_bdev --pool $POOL --image $MIMAGE --bdev $BDEV
      podman images
      podman ps
      podman run -it $IMAGE --server-address $IP --server-port $SRPORT create_subsystem --subnqn $NQN --serial $SERIAL
      podman run -it $IMAGE --server-address $IP --server-port $SRPORT add_namespace --subnqn $NQN --bdev $BDEV
#      podman run -it $IMAGE --server-address $IP --server-port $SRPORT create_listener -n $NQN create_listener client.$POOL.$HOSTNAME -a $IP -s $PORT
      podman run -it $IMAGE --server-address $IP --server-port $SRPORT create_listener -n $NQN -g $GATEWAY -a $IP -s $PORT
      podman run -it $IMAGE --server-address $IP --server-port $SRPORT add_host --subnqn $NQN --host "*"
      nvme discover -t tcp -a $IP -s $PORT
      nvme connect -t tcp --traddr $IP -s $PORT -n $NQN
      nvme list
