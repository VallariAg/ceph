tasks:
- nvmeof:
    client: client.0
    gw_image: quay.io/ceph/nvmeof:1.2 # "default" is the image cephadm defaults to; change to test specific nvmeof images, example "latest"
    rbd:
      pool_name: mypool
      image_name_prefix: myimage
    gateway_config:
      subsystems_count: 3
      namespaces_count: 20
      cli_image: quay.io/ceph/nvmeof-cli:1.2

- cephadm.wait_for_service:
    service: nvmeof.mypool

- workunit:
    no_coverage_and_limits: true
    clients:
      client.2:
        - rbd/nvmeof_setup_subsystem.sh
    env:
      RBD_POOL: mypool
      RBD_IMAGE_PREFIX: myimage

# Test1: add/del new namespaces while fio happens on other ns in background
- workunit:
    no_coverage_and_limits: true
    timeout: 30m
    clients:
      client.2:
        - rbd/nvmeof_basic_tests.sh
        - rbd/nvmeof_fio_test.sh --rbd_iostat
      client.3:
        - rbd/nvmeof_basic_tests.sh
        - rbd/nvmeof_namespace_test.sh
    env:
      RBD_POOL: mypool
      IOSTAT_INTERVAL: '10'
      RUNTIME: '120'
      NEW_NAMESPACES_COUNT: '5'

- print: "[nvmeof] namespace add/del test passed"

# Test2: Namespace load-balancing test
- exec:
    client.0:
    - ls /etc/ceph/ 
    - ceph orch ls nvmeof --export > /etc/ceph/nvmeof-gw.yaml
    - ls /etc/ceph/ 
    - ceph nvme-gw show mypool '' # (assert all deployed) 
    - cat /etc/ceph/nvmeof-gw.yaml
    - pip install yq
    - yq 'del(.placement.hosts[] | select(test(".*nvmeof.a$")))' /etc/ceph/nvmeof-gw.yaml > /etc/ceph/nvmeof-gw-new.yaml
    - ceph orch apply -i /etc/ceph/nvmeof-gw-new.yaml
    - sleep 50
    # redeploy
    - ceph nvme-gw show mypool '' 
    - ceph orch apply -i /etc/ceph/nvmeof-gw.yaml
    # - ceph orch daemon start nvmeof.a
    - sleep 50
    - ceph nvme-gw show mypool '' # (assert all deployed)  

- exec: # stop nvmeof.b
    client.0:
    - cat /etc/ceph/nvmeof-gw.yaml
    - pip install yq
    - yq 'del(.placement.hosts[] | select(test(".*nvmeof.b$")))' /etc/ceph/nvmeof-gw.yaml > /etc/ceph/nvmeof-gw-new.yaml
    - ceph orch apply -i /etc/ceph/nvmeof-gw-new.yaml
    - sleep 50
    # redeploy
    - ceph nvme-gw show mypool '' 
    - ceph orch apply -i /etc/ceph/nvmeof-gw.yaml
    # - ceph orch daemon start nvmeof.b
    - sleep 50
    - ceph nvme-gw show mypool '' # (assert all deployed)  

- print: "[nvmeof] namespace load-balancing test passed"

